
<!DOCTYPE html>
<meta charset="utf-8">
<title></title>
<style>
    path {
        fill: #778899;
    }

    #infographic {
        margin:10px 0%;
        border:2px solid #000;
        border-radius: 5px;
        height:100%;
        overflow:hidden;
        background: #F0F8FF;
    }

    #clickMe {
        margin:5px 0px 0px 270px;
        width: 80px;  height: 30px;
        border: 1px solid #3f3f3f;
        font-size: 110%;

    }

    .country:hover{
        stroke: #6a7b8d;
        stroke-width: 1.5px;
    }

    .hidden { 
        display: none; 
    }
    div.tooltip {
        color: #222; 
        background: #fff; 
        padding: .5em; 
        text-shadow: #f5f5f5 0 1px 0;
        border-radius: 2px; 
        box-shadow: 0px 0px 2px 0px #a6a6a6; 
        opacity: 0.9; 
        position: absolute;
    }


</style>
</head>
<body>
    <div id="infographic">  
        <input id="clickMe" type="button" value="PLAY" onclick="addcities();" />
        <HR WIDTH=100% size=2 color=#000>
        <div id="map"></div>


        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://d3js.org/topojson.v1.min.js"></script>


        <script>

            var cities = [
                {"place": "Algarve, Portugal - Apr-2013", "lon": -7.930834, "lat": 37.0179538, "t": 12.3013698630137},
                {"place": "Amsterdam, Holland - Nov-2007", "lon": 4.8951679, "lat": 52.3702157, "t": 6.84383561643836},
                {"place": "Athens, Greece - Mar-2015", "lon": 23.7293599, "lat": 37.983917, "t": 14.2328767123288},
                {"place": "Barcelona, Spain - Mar-2004", "lon": 2.2734035, "lat": 41.3850639, "t": 3.18356164383562},
                {"place": "Barcelona, Spain - Nov-2014", "lon": 2.1734035, "lat": 41.3850639, "t": 13.8821917808219},
                {"place": "Barcelona, Spain - Nov-2007", "lon": 2.0734035, "lat": 41.3850639, "t": 6.86027397260274},
                {"place": "Basel, Switzerland - Mar-2011", "lon": 7.5885761, "lat": 47.5595986, "t": 10.1780821917808},
                {"place": "Berlin, Germany - Jun-2007", "lon": 13.504954, "lat": 52.5200066, "t": 6.43287671232877},
                {"place": "Berlin, Germany - Jul-2013", "lon": 13.404954, "lat": 52.5200066, "t": 12.5369863013699},
                {"place": "Bratislava, Slovakia - Jul-2004", "lon": 17.1071373, "lat": 48.1458923, "t": 3.52602739726027},
                {"place": "Budapest, Hungary - May-2014", "lon": 19.040235, "lat": 47.497912, "t": 13.3917808219178},
                {"place": "Cologne, Germany - Apr-2007", "lon": 6.9602786, "lat": 50.937531, "t": 6.30958904109589},
                {"place": "Copenhagen, Denmark - Sep-2004", "lon": 12.5683371, "lat": 55.6760968, "t": 3.72876712328767},
                {"place": "Cordoba, Spain - Dec-2015", "lon": -4.7793835, "lat": 37.8881751, "t": 14.9342465753425},
                {"place": "Cork, Ireland - Jun-2003", "lon": -8.4863157, "lat": 51.8968917, "t": 2.41643835616438},
                {"place": "Dalyan, Turkey - Jun-2012", "lon": 28.6425, "lat": 36.834167, "t": 11.4821917808219},
                {"place": "Diano Marina, Italy - Jul-2013", "lon": 8.0828024, "lat": 43.9088641, "t": 12.5232876712329},
                {"place": "Dubrovnik, Croatia - Jun-2002", "lon": 18.0944238, "lat": 42.6506606, "t": 1.44931506849315},
                {"place": "Edirne, Turkey - Nov-2009", "lon": 26.5557145, "lat": 41.6771297, "t": 8.86027397260274},
                {"place": "Florence, Italy - Jun-2015", "lon": 11.2558136, "lat": 43.7695604, "t": 14.4383561643836},
                {"place": "Graz, Austria - Nov-2006", "lon": 15.439504, "lat": 47.070714, "t": 5.86849315068493},
                {"place": "Hamburg, Germany - Apr-2007", "lon": 9.9936818, "lat": 53.5510846, "t": 6.32054794520548},
                {"place": "Helsinki, Finland - Jun-2011", "lon": 24.9410248, "lat": 60.1733244, "t": 10.427397260274},
                {"place": "Hiroshima, Japan - Oct-2014", "lon": 132.4552927, "lat": 34.3852029, "t": 13.7506849315069},
                {"place": "Innsbruck, Austria - Nov-2007", "lon": 11.5041024, "lat": 47.2692124, "t": 6.85753424657534},
                {"place": "Innsbruck, Austria - Nov-2006", "lon": 11.4041024, "lat": 47.2692124, "t": 5.86575342465753},
                {"place": "Istanbul, Turkey - Nov-2009", "lon": 28.9783589, "lat": 41.0082376, "t": 8.83561643835616},
                {"place": "Korcula, Croatia - Jun-2002", "lon": 17.1366886, "lat": 42.958782, "t": 1.44109589041096},
                {"place": "Krakow, Poland - Jul-2014", "lon": 19.8449799, "lat": 50.0646501, "t": 13.5041095890411},
                {"place": "Krakow, Poland - Feb-2011", "lon": 19.9449799, "lat": 50.0646501, "t": 10.1616438356164},
                {"place": "Kyoto, Japan - Oct-2014", "lon": 135.7680294, "lat": 35.0116363, "t": 13.7643835616438},
                {"place": "Lille, France - Nov-2006", "lon": 3.057256, "lat": 50.62925, "t": 5.85753424657534},
                {"place": "Lisbon, Portugal - Apr-2013", "lon": -9.1393366, "lat": 38.7222524, "t": 12.2958904109589},
                {"place": "Luxor, Egypt - Mar-2010", "lon": 32.6396357, "lat": 25.6872431, "t": 9.18904109589041},
                {"place": "Lyon, France - Mar-2009", "lon": 4.835659, "lat": 45.764043, "t": 8.21369863013699},
                {"place": "Madrid, Spain - Mar-2004", "lon": -3.7037902, "lat": 40.4167754, "t": 3.19178082191781},
                {"place": "Malaga, Spain - Dec-2015", "lon": -4.4212655, "lat": 36.721261, "t": 14.9315068493151},
                {"place": "Marrakech, Morocco - Sep-2012", "lon": -7.9810845, "lat": 31.6294723, "t": 11.6958904109589},
                {"place": "Munich, Germany - Jun-2015", "lon": 11.5819806, "lat": 48.1351253, "t": 14.4821917808219},
                {"place": "New York, USA - Nov-2011", "lon": -74.0059413, "lat": 40.7127837, "t": 10.8465753424658},
                {"place": "Osaka, Japan - Oct-2014", "lon": 135.5021651, "lat": 34.6937378, "t": 13.7561643835616},
                {"place": "Paris, France - Nov-2006", "lon": 2.3522219, "lat": 48.856614, "t": 5.86027397260274},
                {"place": "Pisa, Italy - Jun-2015", "lon": 10.4016888, "lat": 43.7228386, "t": 14.4547945205479},
                {"place": "Porto, Portugal - Apr-2013", "lon": -8.6291053, "lat": 41.1579438, "t": 12.2876712328767},
                {"place": "Prague, Czech republic - Jun-2002", "lon": 14.4378005, "lat": 50.0755381, "t": 1.42739726027397},
                {"place": "Reykjavik, Iceland - Mar-2014", "lon": -21.8174393, "lat": 64.1265206, "t": 13.2109589041096},
                {"place": "Rome, Italy - Mar-2008", "lon": 12.4963655, "lat": 41.9027835, "t": 7.17808219178082},
                {"place": "Seville, Spain - Dec-2015", "lon": -5.9844589, "lat": 37.3890924, "t": 14.9397260273973},
                {"place": "Siena, Italy - Jun-2015", "lon": 11.3307574, "lat": 43.318809, "t": 14.4493150684932},
                {"place": "Stockholm, Sweden - Jun-2011", "lon": 18.0685808, "lat": 59.3293235, "t": 10.4164383561644},
                {"place": "Tallinn, Estonia - Jun-2011", "lon": 24.7535746, "lat": 59.4369608, "t": 10.4356164383562},
                {"place": "Tokyo, Japan - Oct-2014", "lon": 139.7319925, "lat": 35.7090259, "t": 13.7753424657534},
                {"place": "Trieste, Italy - Jun-2002", "lon": 13.7768182, "lat": 45.6495264, "t": 1.45479452054795},
                {"place": "Warsaw, Poland - Nov-2013", "lon": 21.0122287, "lat": 52.2296756, "t": 12.9123287671233},
                {"place": "Zagreb, Croatia - Jun-2002", "lon": 15.981919, "lat": 45.8150108, "t": 1.43287671232877},
                {"place": "Berlin, Germany - Apr-2007", "lon": 13.404954, "lat": 52.6200066, "t": 6.31506849315068},
                {"place": "Aswan, Egypt - Mar-2010", "lon": 32.8998293, "lat": 24.088938, "t": 9.19452054794521}

            ];


            var time_lkup = [
                {"year": "Start", "t": 0},
                {"year": 2002, "t": 1},
                {"year": 2003, "t": 2},
                {"year": 2004, "t": 3},
                {"year": 2005, "t": 4},
                {"year": 2006, "t": 5},
                {"year": 2007, "t": 6},
                {"year": 2008, "t": 7},
                {"year": 2009, "t": 8},
                {"year": 2010, "t": 9},
                {"year": 2011, "t": 10},
                {"year": 2012, "t": 11},
                {"year": 2013, "t": 12},
                {"year": 2014, "t": 13},
                {"year": 2015, "t": 14},
                {"year": "End", "t": 15},
            ];

            //speed of animation
            var speed = 4000;
            //scalar value depending on zoom. starts at 1 adjusted in the move function
            var s = 1;
            //find maximum value of t from the time_lkup json for end of animation
            var maxtime = Math.max.apply(Math, time_lkup.map(function (d) {
                return d.t;
            }))

            //declare height and width
            var width = document.getElementById('map').offsetWidth;
            var height = width / 2;

            //declare some vars for use later
            var topo, projection, path, svg, g, throttleTimer;
            //declare tooltip
            var tooltip = d3.select("#map").append("div").attr("class", "tooltip hidden");
            //add in zoom behaviour
            var zoom = d3.behavior.zoom().scaleExtent([1, 9]).on("zoom", move);
            //add in resize bahviour
            var resize = d3.select(window).on("resize", redraw);

            //create functions:

            //setup the mapping svg based on width and height of the browser window
            function setup(width, height) {
                projection = d3.geo.mercator()
                        .center([30, 30]) //long and lat starting position
                        .translate([(width / 2), (height / 2)])
                        .scale(width / 1.3 / Math.PI);
                //.scale( 800);

                path = d3.geo.path().projection(projection);

                svg = d3.select("#map").append("svg")
                        .attr("width", width)
                        .attr("height", height)
                        .attr("class", "map")
                        .call(zoom)
                        .append("g");

                g = svg.append("g");
            }
            ;

            //draw the world map
            function draw(topo) {

                svg.append("path").attr("d", path);

                var country = g.selectAll(".country").data(topo);

                country.enter().insert("path")
                        .attr("class", "country")
                        .attr("d", path)
            }
            ;

            //animated addition of cities onto the world map. called by play button
            function addcities() {

                g.selectAll("circle.points").remove();

                var locations = g.selectAll("circle")
                        .data(cities).enter().append("circle")
                        .style("fill", "red")
                        .style("opacity", 1);

                locations.transition().ease("linear")
                        .delay(function (d) {
                            return speed * d.t;
                        })
                        .attr("cx", function (d) {
                            return projection([d.lon, d.lat])[0];
                        })
                        .attr("cy", function (d) {
                            return projection([d.lon, d.lat])[1];
                        })
                        .attr("r", 8 / s)
                        .transition().duration(500).ease("linear")
                        .style("opacity", 0.6)
                        .attr("r", 4 / s)
                        .attr("class", "points");

                ;
                //tooltip
                locations.on("mousemove", function (d, i) {
                    var mouse = d3.mouse(svg.node()).map(function (d) {
                        return parseInt(d);
                    });
                    tooltip.classed("hidden", false)
                            .attr("style", "left:" + (mouse[0] + offsetL) + "px;top:" + (mouse[1] + offsetT) + "px")
                            .html(d.place);
                })
                        .on("mouseout", function (d, i) {
                            tooltip.classed("hidden", true);
                        });

                //offsets for tooltips
                var offsetL = document.getElementById('map').offsetLeft + 10;
                var offsetT = document.getElementById('map').offsetTop - 30;


                var dispaytime = svg.selectAll(".text")
                        .data(time_lkup).enter().append("text")
                        .style("opacity", 1)
                        .style("fill", "#000000")
                        .transition().delay(function (d) {
                    return speed * d.t;
                })
                        .attr("x", width / 2)
                        .attr("y", height / 2)
                        .attr("class", "display_time")
                        .style("font-size", "50px")
                        .attr("text-anchor", "middle")
                        .text(function (d) {
                            return d.year;
                        })
                        .transition().duration(speed).style("opacity", 0)
                        ;

            }
            ;


            //redraw. this happens when you resize your browser window. it calls throttle which in turn calls redraw. it runs setup and draw again
            function redraw() {
                width = document.getElementById('map').offsetWidth;
                height = width / 2;
                d3.select('svg.map').remove();
                setup(width, height);
                draw(topo);
            }
            ;


            //move this is called when you change the zoom on the map. map is rescaled and city objects are rescaled
            function move() {

                var t = d3.event.translate;
                s = d3.event.scale;
                zscale = s;
                var h = height / 4;


                t[0] = Math.min(
                        (width / height) * (s - 1),
                        Math.max(width * (1 - s), t[0])
                        );

                t[1] = Math.min(
                        h * (s - 1) + h * s,
                        Math.max(height * (1 - s) - h * s, t[1])
                        );

                zoom.translate(t);
                g.attr("transform", "translate(" + t + ")scale(" + s + ")");

                //adjust the country hover stroke width based on zoom level
                d3.selectAll(".country").style("stroke-width", 1.5 / s);

                //adjust the locations size
                g.selectAll("circle").attr("r", 4 / s);

            }
            ;

            //run setup and create initial maps

            setup(width, height);

            d3.json("https://raw.githubusercontent.com/mbostock/topojson/master/examples/world-50m.json", function (error, world) {
                var countries = topojson.feature(world, world.objects.countries).features;
                topo = countries;
                draw(topo);
            });


        </script>
</body>
</html>
